{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\WebSocket.js"],"names":["WS","cc","Class","extends","Component","statics","ip","port","addr","ws","handlers","isPinging","lastSendTime","lastRecieveTime","delay","connected","pingRef","checkRef","msgprefn","addHandler","event","fn","log","handler","data","JSON","parse","connect","fnConnect","fnError","WebSocket","onopen","heartbeat","onmessage","Date","now","json","pass","Reflect","has","operation","onerror","error","onclose","game","on","EVENT_HIDE","ping","setInterval","close","clearInterval","fnDisconnect","send","stringify"],"mappings":"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","file":"WebSocket.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["/*\r\nif(window.io == null){\r\n    window.io = require(\"socket.io\");\r\n}\r\n*/\r\nvar WS = cc.Class({\r\n    extends: cc.Component,\r\n\r\n    statics: {\r\n        ip: null,\r\n        port: null,\r\n        addr: null,\r\n        ws: null,\r\n        handlers: {},\r\n        isPinging: false,\r\n        lastSendTime: 0,\r\n        lastRecieveTime: 0,\r\n        delay: 0,\r\n        connected: false,\r\n        pingRef: null,\r\n        checkRef: null,\r\n        msgprefn: null,\r\n        addHandler: function(event, fn) {\r\n            cc.log(\"AddHandler \", event);\r\n            if (this.handlers[event]) {\r\n                cc.log(\"event:\" + event + \"' handler has been registered.\");\r\n                return;\r\n            }\r\n            const handler = function(data) {\r\n                if (event != \"disconnect\" && typeof data == \"string\") {\r\n                    data = JSON.parse(data);\r\n                }\r\n                fn(data);\r\n            };\r\n            this.handlers[event] = handler;\r\n        },\r\n        connect: function(fnConnect, fnError) {\r\n            cc.log(`connect to ${this.addr}`);\r\n            this.ws = new WebSocket(this.addr);\r\n\r\n            this.ws.onopen = event => {\r\n                cc.log(\"WebSocket instance onopen.\", this.ws);\r\n                this.ws.connected = true;\r\n                fnConnect(event.data);\r\n                this.heartbeat();\r\n            };\r\n            this.ws.onmessage = event => {\r\n                this.lastRecieveTime = Date.now();\r\n                this.delay = this.lastRecieveTime - this.lastSendTime;\r\n                const data = event.data;\r\n                if (\"@\" === data) {\r\n                    //cc.log(\"<<<===pong\");\r\n                    return;\r\n                }\r\n                //cc.log(\"Onmessage:\", event.data);\r\n                const json = JSON.parse(data);\r\n                let pass = true;\r\n                if (this.msgprefn) {\r\n                    pass = this.msgprefn(json);\r\n                }\r\n                if (pass && Reflect.has(this.handlers, json.operation)) {\r\n                    this.handlers[json.operation](json);\r\n                } else {\r\n                    cc.log(\"<<<===[未处理的]：\", json);\r\n                }\r\n            };\r\n\r\n            this.ws.onerror = error => {\r\n                cc.log(\"WebSocket instance error.\");\r\n                fnError(error);\r\n            };\r\n            this.ws.onclose = event => {\r\n                cc.log(\r\n                    \"WebSocket instance closed.\",\r\n                    this.handlers[\"disconnect\"]\r\n                );\r\n                this.ws.connected = false;\r\n                this.isPinging = false;\r\n                if (this.handlers[\"disconnect\"]) {\r\n                    this.handlers[\"disconnect\"]();\r\n                }\r\n            };\r\n        },\r\n        heartbeat: function() {\r\n            this.lastRecieveTime = Date.now();\r\n            if (!this.isPinging) {\r\n                this.isPinging = true;\r\n                cc.game.on(cc.game.EVENT_HIDE, () => {\r\n                    cc.log(\"cc.game.EVENT_HIDE\");\r\n                    this.ping();\r\n                });\r\n                //每5秒ping一下服务器\r\n                this.pingRef = setInterval(() => {\r\n                    if (this.ws) {\r\n                        this.ping();\r\n                    }\r\n                }, 2000);\r\n                //每1000毫秒检查一次最后收到消息时间，如果大于10秒就是断开\r\n\r\n                this.checkRef = setInterval(() => {\r\n                    if (this.ws) {\r\n                        if (Date.now() - this.lastRecieveTime > 10000) {\r\n                            this.close();\r\n                        }\r\n                    }\r\n                }, 1000);\r\n            }\r\n        },\r\n        close: function() {\r\n            clearInterval(this.pingRef);\r\n            clearInterval(this.checkRef);\r\n            if (this.ws && this.ws.connected) {\r\n                this.ws.connected = false;\r\n                this.ws.close();\r\n            }\r\n            if (this.fnDisconnect) {\r\n                this.fnDisconnect();\r\n                this.fnDisconnect = null;\r\n            }\r\n        },\r\n        send: function(data) {\r\n            if (this.ws && this.ws.connected) {\r\n                if (data && typeof data == \"object\") {\r\n                    data == JSON.stringify(data);\r\n                }\r\n                this.ws.send(data);\r\n            }\r\n        },\r\n        ping: function() {\r\n            if (this.ws) {\r\n                this.lastSendTime = Date.now();\r\n                this.send(\"@\");\r\n                //cc.log(\"===>>>ping\");\r\n            }\r\n        }\r\n    }\r\n});\r\n"]}