{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\WebSocket.js"],"names":["WS","cc","Class","extends","Component","statics","ip","port","addr","ws","handlers","fnDisconnect","isPinging","lastSendTime","lastRecieveTime","delay","connected","pingRef","checkRef","msgprefn","addHandler","event","fn","log","handler","data","JSON","parse","connect","fnConnect","fnError","WebSocket","onopen","heartbeat","onmessage","self","Date","now","json","pass","Reflect","has","operation","onerror","error","onclose","game","on","EVENT_HIDE","ping","setInterval","close","clearInterval","send","stringify"],"mappings":"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","file":"WebSocket.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["/*\r\nif(window.io == null){\r\n    window.io = require(\"socket.io\");\r\n}\r\n*/\r\nvar WS = cc.Class({\r\n    extends: cc.Component,\r\n\r\n    statics: {\r\n        ip: null,\r\n        port: null,\r\n        addr: null,\r\n        ws: null,\r\n        handlers: {},\r\n        fnDisconnect: null,\r\n        isPinging: false,\r\n        lastSendTime: 0,\r\n        lastRecieveTime: 0,\r\n        delay: 0,\r\n        connected: false,\r\n        pingRef: null,\r\n        checkRef: null,\r\n        msgprefn: null,\r\n        addHandler: function(event, fn) {\r\n            cc.log(\"AddHandler \", event);\r\n            if (this.handlers[event]) {\r\n                cc.log(\"event:\" + event + \"' handler has been registered.\");\r\n                return;\r\n            }\r\n            const handler = function(data) {\r\n                if (event != \"disconnect\" && typeof data == \"string\") {\r\n                    data = JSON.parse(data);\r\n                }\r\n                fn(data);\r\n            };\r\n            this.handlers[event] = handler;\r\n        },\r\n        connect: function(fnConnect, fnError) {\r\n            cc.log(`connect to ${this.addr}`);\r\n            this.ws = new WebSocket(this.addr);\r\n\r\n            this.ws.onopen = event => {\r\n                cc.log(\"WebSocket instance onopen.\", this.ws);\r\n                this.ws.connected = true;\r\n                fnConnect(event.data);\r\n                this.heartbeat();\r\n            };\r\n            this.ws.onmessage = event => {\r\n                let self = this;\r\n                this.lastRecieveTime = Date.now();\r\n                this.delay = this.lastRecieveTime - this.lastSendTime;\r\n                const data = event.data;\r\n                if (\"@\" === data) {\r\n                    //cc.log(\"<<<===pong\");\r\n                    return;\r\n                }\r\n                const json = JSON.parse(data);\r\n                let pass = true;\r\n                if (this.msgprefn) {\r\n                    pass = this.msgprefn(json);\r\n                }\r\n                if (pass && Reflect.has(this.handlers, json.operation)) {\r\n                    this.handlers[json.operation](json);\r\n                } else {\r\n                    cc.log(\"<<<===[未处理的]：\", json);\r\n                }\r\n            };\r\n\r\n            this.ws.onerror = error => {\r\n                cc.log(\"WebSocket instance error.\");\r\n                fnError(error);\r\n            };\r\n            let self = this;\r\n            this.ws.onclose = event => {\r\n                cc.log(\"WebSocket instance closed.\");\r\n                this.ws.connected = false;\r\n                this.isPinging = false;\r\n            };\r\n        },\r\n        heartbeat: function() {\r\n            this.lastRecieveTime = Date.now();\r\n            if (!this.isPinging) {\r\n                this.isPinging = true;\r\n                cc.game.on(cc.game.EVENT_HIDE, () => {\r\n                    cc.log(\"cc.game.EVENT_HIDE\");\r\n                    this.ping();\r\n                });\r\n                //每5秒ping一下服务器\r\n                this.pingRef = setInterval(() => {\r\n                    if (this.ws) {\r\n                        this.ping();\r\n                    }\r\n                }, 2000);\r\n                //每1000毫秒检查一次最后收到消息时间，如果大于10秒就是断开\r\n\r\n                this.checkRef = setInterval(() => {\r\n                    if (this.ws) {\r\n                        if (Date.now() - this.lastRecieveTime > 10000) {\r\n                            this.close();\r\n                        }\r\n                    }\r\n                }, 1000);\r\n            }\r\n        },\r\n        close: function() {\r\n            clearInterval(this.pingRef);\r\n            clearInterval(this.checkRef);\r\n            if (this.ws && this.ws.connected) {\r\n                this.ws.connected = false;\r\n                this.ws.close();\r\n            }\r\n            if (this.fnDisconnect) {\r\n                this.fnDisconnect();\r\n                this.fnDisconnect = null;\r\n            }\r\n        },\r\n        send: function(data) {\r\n            if (this.ws && this.ws.connected) {\r\n                if (data && typeof data == \"object\") {\r\n                    data == JSON.stringify(data);\r\n                }\r\n                this.ws.send(data);\r\n            }\r\n        },\r\n        ping: function() {\r\n            if (this.ws) {\r\n                this.lastSendTime = Date.now();\r\n                this.send(\"@\");\r\n                //cc.log(\"===>>>ping\");\r\n            }\r\n        }\r\n    }\r\n});\r\n"]}